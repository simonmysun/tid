<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TID</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.css">
    <style>
     .split {
       -webkit-box-sizing: border-box;
       -moz-box-sizing: border-box;
       box-sizing: border-box;

       overflow-y: auto;
       overflow-x: hidden;
     }

     .gutter {
       background-color: #f6f6f6;

       background-repeat: no-repeat;
       background-position: 50%;
     }

     .gutter.gutter-horizontal {
       background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABo7865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII=');
       cursor: ew-resize;
     }

     .gutter.gutter-vertical {
       background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
       cursor: ns-resize;
     }

     .split.split-horizontal, .gutter.gutter-horizontal {
       height: 100%;
       float: left;
     }

     .content {
       border: 1px solid #C0C0C0;
       background-color: #fff;
     }
     
     #config {
       color: #777;
       position: absolute;
       top: 0;
       right: 0;
       bottom: auto;
       left: 0;
       height: 30px;
       background: #f6f6f6;
     }

     .btn {
       margin: 3px 5px auto 5px;
       display: inline-block;
       background: #fff;
       color: #777;
       text-decoration: none;
       border: 1px solid #c0c0c0;
       padding: 2px 5px;
     }

     #wrapper {
       position: absolute;
       top: 30px;
       right: 0;
       bottom: 0;
       left: 0;
     }

     #codemirror, #preview, #preview-iframe, .CodeMirror {
       height: 100%;
       width: 100%;
     }
    </style>
  </head>
  <body>
    <div id="config">
      <a href="#" class="btn" id="btn-save">SAVE</a>
    </div>
    <div id="wrapper">
      <div id="codemirror" class="content split split-horizontal"></div>
      <div id="preview" class="content split split-horizontal">
        <iframe id="preview-iframe" frameborder="0"></iframe>
      </div>
    </div>
    <script src="//nathancahill.github.io/Split.js/split.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/addon/mode/loadmode.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/mode/meta.js"></script>
    <script type="text/javascript" charset="utf-8">
     var path = '/_demo.md';
     var demoText = '# Tid Test\n\
\n\
This is a demo page of **[tid](https://github.com/simonmysun/tid)** software at version 0.0.7. This page may be out of date. With locally installed you can experience creating, updating files and faster loading, etc. \n\
\n\
<!-- advertisement -->\n\
<p><a href="https://github.com/simonmysun/tid" style="font-size:120%;background-image:-webkit-gradient(linear,left top,right top,color-stop(0,#f22),color-stop(0.15,#f2f),color-stop(0.3,#22f),color-stop(0.45,#2ff),color-stop(0.6,#2f2),color-stop(0.75,#2f2),color-stop(0.9,#ff2),color-stop(1,#f22));background-image:gradient(linear,left top,right top,color-stop(0,#f22),color-stop(0.15,#f2f),color-stop(0.3,#22f),color-stop(0.45,#2ff),color-stop(0.6,#2f2),color-stop(0.75,#2f2),color-stop(0.9,#ff2),color-stop(1,#f22));color:transparent!important;-webkit-background-clip:text;background-clip:text">CLICK FOR MORE DETAILS</a></p>\n\
\n\
Let\'s try some real time $\TeX$ rendering: \n\
\n\
When $a \\ne 0$, there are two solutions to $ax^2 + bx + c = 0$ and they are $$x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}.$$\n\
\n\
Modify them and see what happens! \n';
     Split(['#codemirror', '#preview'], {
       sizes: [29, 71],
       minSize: 200
     });
     var editor = CodeMirror(document.getElementById('codemirror'), {
       value: demoText,
       lineNumbers: true,
       lineWrapping: true
     });
     CodeMirror.modeURL = '//cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/mode/%N/%N.js';
     var mode;
     var spec;
     var info = CodeMirror.findModeByExtension(path.split('.').pop().toLowerCase());
     if (info) {
       mode = info.mode;
       spec = info.mime;
     }
     if (mode) {
       editor.setOption('mode', spec);
       CodeMirror.autoLoadMode(editor, mode);
     } else {
       console.log('Could not find a mode corresponding to ' + val);
     }
     editor.on('change', (function(callback, delay, maxDelay, init, destroy) {
       var timer = null;
       var startTime;
       return function () {
         var context = this;
         var args = arguments;
         var currentTime = new Date().getTime();
         clearTimeout(timer);
         if (!startTime) {
           startTime = currentTime;
           init();
         } else if (currentTime - startTime >= maxDelay) {
           callback.apply(context, args);
           startTime = currentTime;
         }
         timer = setTimeout(function () {
           callback.apply(context, args);
           startTime = null;
           destroy();
         }, delay);
       }
     })(function(editor, change) {
       if (change.origin === 'setValue') {
         console.log('Aborted');
         return; 
       }
       window.localStorage.setItem('__broadcast', JSON.stringify({path: path, content: editor.getValue()}));
     }, 300, 1000, function() {}, function() {}));
     document.getElementById('preview-iframe').src = './viewer.html#' + path;
     document.getElementById('preview-iframe').onload = function() {
       window.localStorage.setItem('__broadcast', JSON.stringify({path: path, content: editor.getValue()}));
     };
     document.getElementById('btn-save').addEventListener('click', function() {
       alert('NOT IMPLEMENTED!');
     });
     window.addEventListener('storage', (event) => {
       if (event.key === '__broadcast') {
         if (event.newValue !== null) {
           const data = JSON.parse(event.newValue);
           if (data.path === path) {
             if(editor.getValue() !== data.content) {
               editor.setValue(data.content);
             }
             window.localStorage.removeItem('__broadcast');
           }
         }
       }
     });
    </script>
  </body>
</html>
